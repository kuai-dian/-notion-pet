/**
 * tdesign v0.8.0
 * (c) 2022 tdesign
 * @license MIT
 */

import _asyncToGenerator from '@babel/runtime/helpers/asyncToGenerator';
import _defineProperty from '@babel/runtime/helpers/defineProperty';
import { isVNode, defineComponent, createVNode, Fragment, withDirectives, resolveComponent, mergeProps, vShow } from 'vue';
import _regeneratorRuntime from '@babel/runtime/regenerator';
import isArray from 'lodash/isArray';
import isEmpty from 'lodash/isEmpty';
import isNumber from 'lodash/isNumber';
import isString from 'lodash/isString';
import isBoolean from 'lodash/isBoolean';
import _isObject from 'lodash/isObject';
import isFunction from 'lodash/isFunction';
import isNil from 'lodash/isNil';
import { CloseCircleFilledIcon } from 'tdesign-icons-vue-next';
import { Loading } from '../loading/index.js';
import mixins from '../utils/mixins.js';
import getConfigReceiverMixins from '../config-provider/config-receiver.js';
import { renderTNodeJSX } from '../utils/render-tnode.js';
import { Popup } from '../popup/index.js';
import { Tag } from '../tag/index.js';
import { Tree } from '../tree/index.js';
import { Input } from '../input/index.js';
import FakeArrow from '../common-components/fake-arrow.js';
import { emitEvent } from '../utils/event.js';
import ClASSNAMES from '../utils/classnames.js';
import props from './props.js';
import { prefix } from '../config.js';
import '../loading/loading.js';
import '@babel/runtime/helpers/slicedToArray';
import '../loading/icon/gradient.js';
import '../_common/js/loading/circle-adapter.js';
import '../_common/js/utils/set-style.js';
import '../_common/js/utils/helper.js';
import '@babel/runtime/helpers/objectWithoutProperties';
import '../utils/dom.js';
import '../_chunks/dep-b66bfe36.js';
import '../utils/easing.js';
import '../utils/transfer-dom.js';
import '../loading/props.js';
import '../utils/withInstall.js';
import './style/css.js';
import '../loading/type.js';
import '../loading/plugin.js';
import '../config-provider/zh_CN_config.js';
import '../config-provider/type.js';
import '../popup/popup.js';
import '@babel/runtime/helpers/typeof';
import '@popperjs/core';
import '../popup/props.js';
import '../utils/set-style.js';
import '../utils/map-props.js';
import 'lodash/kebabCase';
import '../popup/type.js';
import '../utils/helper.js';
import 'lodash/camelCase';
import '../tag/tag.js';
import '../tag/props.js';
import '../tag/check-tag.js';
import '../tag/check-tag-props.js';
import '../tag/type.js';
import '../tree/td-tree.js';
import 'lodash/upperFirst';
import 'lodash/pick';
import '../_common/js/tree/tree-store.js';
import '@babel/runtime/helpers/classCallCheck';
import '@babel/runtime/helpers/createClass';
import 'lodash/difference';
import 'lodash/isPlainObject';
import '../_common/js/tree/tree-node.js';
import '@babel/runtime/helpers/toConsumableArray';
import 'lodash/uniqueId';
import 'lodash/get';
import '../_common/js/tree/tree-node-model.js';
import '../_common/js/log/log.js';
import '../tree/tree-item.js';
import '../checkbox/index.js';
import '../checkbox/checkbox.js';
import '../checkbox/props.js';
import '../checkbox/group.js';
import 'lodash/intersection';
import '../checkbox/checkbox-group-props.js';
import '../checkbox/type.js';
import '../tree/util.js';
import '../tree/constants.js';
import '../utils/ripple.js';
import '../tree/props.js';
import '../tree/type.js';
import '../input/addon.js';
import '../input/input.js';
import '../input/props.js';
import '../input/input-group.js';
import '../input/type.js';

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }

function _isSlot(s) {
  return typeof s === 'function' || Object.prototype.toString.call(s) === '[object Object]' && !isVNode(s);
}

var name = "".concat(prefix, "-tree-select");
var _TreeSelect = defineComponent(_objectSpread(_objectSpread({}, mixins(getConfigReceiverMixins("treeSelect"))), {}, {
  name: "TTreeSelect",
  components: {
    Tree: Tree
  },
  props: _objectSpread({}, props),
  emits: ["change", "clear", "focus", "blur", "remove", "search"],
  data: function data() {
    return {
      visible: false,
      isHover: false,
      focusing: false,
      defaultProps: {
        trigger: "click",
        placement: "bottom-left",
        overlayClassName: "",
        overlayStyle: function overlayStyle(trigger) {
          return {
            width: "".concat(trigger.offsetWidth, "px"),
            border: "1px solid #dcdcdc"
          };
        }
      },
      filterText: "",
      filterByText: null,
      actived: [],
      expanded: [],
      nodeInfo: null,
      treeKey: 0
    };
  },
  computed: {
    classes: function classes() {
      var _ref;

      return ["".concat(prefix, "-select"), (_ref = {}, _defineProperty(_ref, ClASSNAMES.STATUS.disabled, this.disabled), _defineProperty(_ref, ClASSNAMES.STATUS.active, this.visible), _defineProperty(_ref, ClASSNAMES.SIZE[this.size], this.size), _defineProperty(_ref, "".concat(prefix, "-has-prefix"), this.prefixIconSlot), _defineProperty(_ref, "".concat(prefix, "-select-selected"), this.selectedSingle || !isEmpty(this.selectedMultiple)), _ref)];
    },
    popupClass: function popupClass() {
      var popupObject = this.popupObject;
      return "".concat(popupObject.overlayClassName, " ").concat(prefix, "-select__dropdown narrow-scrollbar");
    },
    isObjectValue: function isObjectValue() {
      return this.valueType === "object";
    },
    checked: function checked() {
      if (this.multiple) {
        if (this.isObjectValue) {
          return isArray(this.value) ? this.value.map(function (item) {
            return item.value;
          }) : [];
        }

        return isArray(this.value) ? this.value : [];
      }

      return [];
    },
    showArrow: function showArrow() {
      return !this.clearable || !this.isHover || this.disabled || !this.multiple && !this.value && this.value !== 0 || this.multiple && isArray(this.value) && isEmpty(this.value);
    },
    showLoading: function showLoading() {
      return this.loading && !this.disabled;
    },
    showClose: function showClose() {
      return this.clearable && this.isHover && !this.disabled && (!this.multiple && (!!this.value || this.value === 0) || this.multiple && !isEmpty(this.value));
    },
    showPlaceholder: function showPlaceholder() {
      if (!this.showFilter && (isString(this.value) && this.value === "" && !this.selectedSingle || isArray(this.value) && isEmpty(this.value) || isNil(this.value))) {
        return true;
      }

      return false;
    },
    showFilter: function showFilter() {
      if (this.disabled) {
        return false;
      }

      if (!this.multiple && this.selectedSingle && (this.filterable || isFunction(this.filter))) {
        return this.visible;
      }

      return this.filterable || isFunction(this.filter);
    },
    showTree: function showTree() {
      return !this.loading;
    },
    popupObject: function popupObject() {
      var propsObject = this.popupProps ? _objectSpread(_objectSpread({}, this.defaultProps), this.popupProps) : this.defaultProps;
      return propsObject;
    },
    selectedSingle: function selectedSingle() {
      if (!this.multiple && (isString(this.value) || isNumber(this.value) || _isObject(this.value))) {
        if (this.nodeInfo) {
          return this.nodeInfo.label;
        }

        return "".concat(this.value);
      }

      return "";
    },
    selectedMultiple: function selectedMultiple() {
      if (this.multiple && isArray(this.value) && !isEmpty(this.value)) {
        return this.value;
      }

      return [];
    },
    multiLimitDisabled: function multiLimitDisabled() {
      if (this.multiple && this.max && isArray(this.value) && this.max <= this.value.length) {
        return true;
      }

      return false;
    },
    filterPlaceholder: function filterPlaceholder() {
      if (this.multiple && isArray(this.value) && !isEmpty(this.value)) {
        return "";
      }

      if (!this.multiple && this.selectedSingle) {
        return this.selectedSingle;
      }

      return this.placeholder;
    },
    loadingTextSlot: function loadingTextSlot() {
      var useLocale = !this.loadingText && !this.$slots.loadingText;
      return useLocale ? createVNode("div", {
        "class": "".concat(prefix, "-select__empty")
      }, [this.t(this.global.loadingText)]) : renderTNodeJSX(this, "loadingText");
    },
    emptySlot: function emptySlot() {
      var useLocale = !this.empty && !this.$slots.empty;
      return useLocale ? createVNode("div", {
        "class": "".concat(prefix, "-select__empty")
      }, [this.t(this.global.empty)]) : renderTNodeJSX(this, "empty");
    },
    prefixIconSlot: function prefixIconSlot() {
      return renderTNodeJSX(this, "prefixIcon");
    },
    realLabel: function realLabel() {
      var treeProps = this.treeProps;

      if (!isEmpty(treeProps) && !isEmpty(treeProps.keys)) {
        return treeProps.keys.label || "label";
      }

      return "label";
    },
    realValue: function realValue() {
      var treeProps = this.treeProps;

      if (!isEmpty(treeProps) && !isEmpty(treeProps.keys)) {
        return treeProps.keys.value || "value";
      }

      return "value";
    },
    tagList: function tagList() {
      if (this.nodeInfo && isArray(this.nodeInfo)) {
        return this.nodeInfo.map(function (node) {
          return node.label;
        });
      }

      return this.isObjectValue ? [] : this.selectedMultiple;
    }
  },
  watch: {
    value: function value() {
      var _this = this;

      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {
        return _regeneratorRuntime.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                _context.next = 2;
                return _this.changeNodeInfo();

              case 2:
                if (!_this.multiple) {
                  _this.actived = _this.nodeInfo ? [_this.nodeInfo.value] : [];
                }

              case 3:
              case "end":
                return _context.stop();
            }
          }
        }, _callee);
      }))();
    },
    data: function data() {
      var _this2 = this;

      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {
        return _regeneratorRuntime.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                _context2.next = 2;
                return _this2.changeNodeInfo();

              case 2:
                _this2.treeRerender();

              case 3:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2);
      }))();
    }
  },
  mounted: function mounted() {
    var _this3 = this;

    return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {
      return _regeneratorRuntime.wrap(function _callee3$(_context3) {
        while (1) {
          switch (_context3.prev = _context3.next) {
            case 0:
              if (!(!_this3.value && _this3.defaultValue)) {
                _context3.next = 3;
                break;
              }

              _context3.next = 3;
              return _this3.change(_this3.defaultValue, null);

            case 3:
              if (_this3.isObjectValue) {
                _this3.actived = isArray(_this3.value) ? _this3.value.map(function (item) {
                  return item.value;
                }) : [_this3.value.value];
              } else {
                _this3.actived = isArray(_this3.value) ? _this3.value : [_this3.value];
              }

              _this3.changeNodeInfo();

            case 5:
            case "end":
              return _context3.stop();
          }
        }
      }, _callee3);
    }))();
  },
  methods: {
    popupVisibleChange: function popupVisibleChange(visible) {
      var _this4 = this;

      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {
        var searchInput;
        return _regeneratorRuntime.wrap(function _callee4$(_context4) {
          while (1) {
            switch (_context4.prev = _context4.next) {
              case 0:
                _context4.next = 2;
                return _this4.visible = visible;

              case 2:
                if (_this4.showFilter && _this4.visible) {
                  searchInput = _this4.$refs.input;
                  searchInput === null || searchInput === void 0 ? void 0 : searchInput.focus();
                  _this4.focusing = true;
                }

              case 3:
              case "end":
                return _context4.stop();
            }
          }
        }, _callee4);
      }))();
    },
    removeTag: function removeTag(index, data, e) {
      if (this.disabled) {
        return;
      }

      this.remove({
        value: this.value[index],
        data: data,
        e: e
      });
      isArray(this.value) && this.value.splice(index, 1);
      this.change(this.value, null);
    },
    change: function change(value, node) {
      emitEvent(this, "change", value, {
        node: node
      });
      this.changeNodeInfo();
    },
    clear: function clear(e) {
      e.stopPropagation();
      var defaultValue = this.multiple ? [] : "";
      this.change(defaultValue, null);
      this.actived = [];
      this.filterText = "";
      emitEvent(this, "clear", {
        e: e
      });
    },
    focus: function focus(e) {
      this.focusing = true;
      emitEvent(this, "focus", {
        value: this.value,
        e: e
      });
    },
    blur: function blur(e) {
      this.focusing = false;
      this.filterText = "";
      emitEvent(this, "blur", {
        value: this.value,
        e: e
      });
    },
    remove: function remove(options) {
      emitEvent(this, "remove", options);
    },
    search: function search(filterWords) {
      emitEvent(this, "search", filterWords);
    },
    treeNodeChange: function treeNodeChange(value, context) {
      var _this5 = this;

      var current = value;

      if (this.isObjectValue) {
        var tree = this.$refs.tree;
        current = value.map(function (nodeValue) {
          var node = tree.getItem(nodeValue);
          return {
            label: node.data[_this5.realLabel],
            value: node.data[_this5.realValue]
          };
        });
      }

      this.change(current, context.node);
      this.actived = value;
    },
    treeNodeActive: function treeNodeActive(value, context) {
      if (this.multiple) {
        return;
      }

      var current = value;

      if (this.isObjectValue) {
        var tree = this.$refs.tree;
        var nodeValue = isEmpty(value) ? "" : value[0];
        var node = tree.getItem(nodeValue);
        current = {
          label: node.data[this.realLabel],
          value: node.data[this.realValue]
        };
      } else {
        current = isEmpty(value) ? "" : value[0];
      }

      this.change(current, context.node);
      this.actived = value;
      this.visible = false;
    },
    treeNodeExpand: function treeNodeExpand(value) {
      this.expanded = value;
    },
    onInput: function onInput() {
      var _this6 = this;

      this.filterByText = function (node) {
        if (isFunction(_this6.filter)) {
          var filter = _this6.filter(_this6.filterText, node);

          if (isBoolean(filter)) {
            return filter;
          }
        }

        return node.data[_this6.realLabel].indexOf(_this6.filterText) >= 0;
      };

      this.search(this.filterText);
    },
    changeNodeInfo: function changeNodeInfo() {
      var _this7 = this;

      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5() {
        var tree, nodeValue, node;
        return _regeneratorRuntime.wrap(function _callee5$(_context5) {
          while (1) {
            switch (_context5.prev = _context5.next) {
              case 0:
                tree = _this7.$refs.tree;
                _context5.next = 3;
                return _this7.value;

              case 3:
                if (tree && !_this7.multiple && _this7.value) {
                  nodeValue = _this7.isObjectValue ? _this7.value.value : _this7.value;

                  if (!isEmpty(_this7.data)) {
                    node = tree.getItem(nodeValue);
                    _this7.nodeInfo = {
                      label: node.data[_this7.realLabel],
                      value: node.data[_this7.realValue]
                    };
                  } else {
                    _this7.nodeInfo = {
                      label: nodeValue,
                      value: nodeValue
                    };
                  }
                } else if (tree && _this7.multiple && isArray(_this7.value)) {
                  _this7.nodeInfo = _this7.value.map(function (value) {
                    var nodeValue = _this7.isObjectValue ? value.value : value;

                    if (!isEmpty(_this7.data)) {
                      var _node = tree.getItem(nodeValue);

                      return {
                        label: _node.data[_this7.realLabel],
                        value: _node.data[_this7.realValue]
                      };
                    }

                    return {
                      label: nodeValue,
                      value: nodeValue
                    };
                  });
                } else {
                  _this7.nodeInfo = null;
                }

              case 4:
              case "end":
                return _context5.stop();
            }
          }
        }, _callee5);
      }))();
    },
    treeRerender: function treeRerender() {
      this.treeKey += 1;
    }
  },
  render: function render() {
    var _this8 = this,
        _ref2;

    var treeProps = this.treeProps,
        popupObject = this.popupObject,
        classes = this.classes,
        popupClass = this.popupClass,
        treeKey = this.treeKey;
    var iconStyle = {
      "font-size": this.size
    };
    var treeSlots = {
      empty: function empty() {
        return createVNode(Fragment, null, [_this8.emptySlot]);
      }
    };

    var treeItem = withDirectives(createVNode(resolveComponent("tree"), mergeProps({
      "ref": "tree",
      "key": treeKey,
      "value": this.checked,
      "hover": true,
      "expandAll": true,
      "expandOnClickNode": true,
      "data": this.data,
      "activable": !this.multiple,
      "checkable": this.multiple,
      "disabled": this.disabled || this.multiLimitDisabled,
      "empty": this.empty,
      "size": this.size,
      "filter": this.filterByText,
      "actived": this.actived,
      "expanded": this.expanded,
      "activeMultiple": this.multiple,
      "onChange": this.treeNodeChange,
      "onActive": this.treeNodeActive,
      "onExpand": this.treeNodeExpand
    }, treeProps), treeSlots), [[vShow, this.showTree]]);

    var searchInput = withDirectives(createVNode(Input, {
      "ref": "input",
      "modelValue": _this8.filterText,
      "onUpdate:modelValue": function onUpdateModelValue($event) {
        return _this8.filterText = $event;
      },
      "class": "".concat(prefix, "-select__input"),
      "size": this.size,
      "disabled": this.disabled,
      "placeholder": this.filterPlaceholder,
      "onInput": this.onInput,
      "onBlur": function onBlur(value, context) {
        return _this8.blur(context.e);
      },
      "onFocus": function onFocus(value, context) {
        return _this8.focus(context.e);
      }
    }, null), [[vShow, this.showFilter]]);

    var tagItem = this.tagList.map(function (label, index) {
      return withDirectives(createVNode(Tag, {
        "key": index,
        "size": _this8.size,
        "closable": !_this8.disabled,
        "disabled": _this8.disabled,
        "onClose": function onClose(context) {
          return _this8.removeTag(index, null, context.e);
        }
      }, _isSlot(label) ? label : {
        "default": function _default() {
          return [label];
        }
      }), [[vShow, _this8.minCollapsedNum <= 0 || index < _this8.minCollapsedNum]]);
    });
    var selectedSingle = this.valueDisplay || this.$slots.valueDisplay ? renderTNodeJSX(this, "valueDisplay", {
      params: {
        value: this.nodeInfo || (_ref2 = {}, _defineProperty(_ref2, this.realLabel, ""), _defineProperty(_ref2, this.realValue, ""), _ref2)
      }
    }) : createVNode("span", {
      "title": this.selectedSingle,
      "class": "".concat(prefix, "-select__single")
    }, [this.selectedSingle]);
    var collapsedItem = (this.collapsedItems || this.$slots.collapsedItems) && this.minCollapsedNum > 0 && this.tagList.length > this.minCollapsedNum ? renderTNodeJSX(this, "collapsedItems", {
      params: {
        count: this.tagList.length - this.minCollapsedNum,
        value: this.selectedMultiple,
        collapsedSelectedItems: this.selectedMultiple.slice(this.minCollapsedNum)
      }
    }) : withDirectives(createVNode(Tag, {
      "size": this.size
    }, {
      "default": function _default() {
        return ["+".concat(_this8.tagList.length - _this8.minCollapsedNum)];
      }
    }), [[vShow, this.minCollapsedNum > 0 && this.tagList.length > this.minCollapsedNum]]);
    var slots = {
      content: function content() {
        return createVNode("div", null, [withDirectives(createVNode("p", {
          "class": "".concat(prefix, "-select-loading-tips")
        }, [_this8.loadingTextSlot]), [[vShow, _this8.showLoading]]), treeItem]);
      }
    };
    return createVNode("div", {
      "ref": "treeSelect"
    }, [createVNode(Popup, {
      "ref": "popup",
      "class": "".concat(prefix, "-select__popup-reference"),
      "visible": this.visible,
      "disabled": this.disabled,
      "placement": popupObject.placement,
      "trigger": popupObject.trigger,
      "overlayStyle": popupObject.overlayStyle,
      "overlayClassName": popupClass,
      "onVisibleChange": this.popupVisibleChange,
      "expandAnimation": true
    }, _objectSpread({
      "default": function _default() {
        return [createVNode("div", {
          "class": classes,
          "onmouseenter": function onmouseenter() {
            return _this8.isHover = true;
          },
          "onmouseleave": function onmouseleave() {
            return _this8.isHover = false;
          }
        }, [_this8.prefixIconSlot && createVNode("span", {
          "class": "".concat(prefix, "-select__left-icon")
        }, [_this8.prefixIconSlot[0]]), withDirectives(createVNode("span", {
          "class": "".concat(prefix, "-select__placeholder")
        }, [_this8.placeholder]), [[vShow, _this8.showPlaceholder]]), tagItem, collapsedItem, !_this8.multiple && !_this8.showPlaceholder && !_this8.showFilter && selectedSingle, searchInput, _this8.showArrow && !_this8.showLoading && createVNode(FakeArrow, {
          "overlayClassName": "".concat(prefix, "-select__right-icon"),
          "overlayStyle": iconStyle,
          "isActive": _this8.visible && !_this8.disabled
        }, null), withDirectives(createVNode(CloseCircleFilledIcon, {
          "name": "close",
          "class": "".concat(prefix, "-select__right-icon ").concat(prefix, "-select__right-icon-clear"),
          "size": _this8.size,
          "onClick": function onClick(_ref3) {
            var e = _ref3.e;
            return _this8.clear(e);
          }
        }, null), [[vShow, _this8.showClose && !_this8.showLoading]]), withDirectives(createVNode(Loading, {
          "name": "loading",
          "class": "".concat(prefix, "-select__right-icon ").concat(prefix, "-select__active-icon"),
          "size": "small"
        }, null), [[vShow, _this8.showLoading]])])];
      }
    }, slots))]);
  }
}));

export { _TreeSelect as default };
//# sourceMappingURL=tree-select.js.map
