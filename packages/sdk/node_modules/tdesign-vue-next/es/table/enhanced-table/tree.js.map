{"version":3,"file":"tree.js","sources":["../../../src/table/enhanced-table/tree.tsx"],"sourcesContent":["import { defineComponent } from 'vue';\nimport { AddRectangleIcon, MinusRectangleIcon } from 'tdesign-icons-vue-next';\nimport get from 'lodash/get';\nimport cloneDeep from 'lodash/cloneDeep';\nimport baseTableProps from '../base-table-props';\nimport primaryTableProps from '../primary-table-props';\nimport enhancedTableProps from '../enhanced-table-props';\nimport {\n  TdPrimaryTableProps,\n  TableRowState,\n  TableRowValue,\n  PrimaryTableCellParams,\n  TableRowData,\n  TableTreeConfig,\n} from '../type';\nimport { getCell } from '../util/common';\nimport TableTreeStore, { KeysType } from './tree-store';\n\nexport default defineComponent({\n  props: {\n    rowKey: baseTableProps.rowKey,\n    data: baseTableProps.data,\n    columns: primaryTableProps.columns,\n    tree: enhancedTableProps.tree,\n  },\n  data() {\n    return {\n      store: new TableTreeStore() as InstanceType<typeof TableTreeStore>,\n      dataSource: [],\n    };\n  },\n  computed: {\n    rowDataKeys(): KeysType {\n      return {\n        rowKey: this.rowKey,\n        childrenKey: this.childrenKey,\n      };\n    },\n    childrenKey(): string {\n      return (this.tree as TableTreeConfig)?.childrenKey || 'children';\n    },\n    columnsSource(): TdPrimaryTableProps['columns'] {\n      let treeNodeColumnIndex = (this.tree as TableTreeConfig)?.treeNodeColumnIndex || 0;\n      // type 存在，则表示表格内部渲染的特殊列，不能作为树结点列。因此树结点展开列向后顺移一位\n      if (this.columns[treeNodeColumnIndex]?.type) {\n        treeNodeColumnIndex += 1;\n      }\n      const cols = [...this.columns];\n      const treeNodeCol = { ...this.columns[treeNodeColumnIndex] };\n      // 定义树节点列\n      treeNodeCol.cell = (h, p) => {\n        const cellInfo = getCell(this, { ...p, col: this.columns[treeNodeColumnIndex] });\n        const currentState = this.store.treeDataMap.get(get(p.row, this.rowKey));\n        const colStyle = this.getTreeNodeStyle(currentState?.level);\n        const childrenNodes = get(p.row, this.childrenKey);\n        if (childrenNodes && childrenNodes instanceof Array) {\n          const IconNode = this.store.treeDataMap.get(get(p.row, this.rowKey))?.expanded\n            ? MinusRectangleIcon\n            : AddRectangleIcon;\n          return (\n            <div style={colStyle}>\n              {!!childrenNodes.length && (\n                <IconNode style={{ marginRight: '8px' }} onClick={() => this.toggleExpandData(p)} />\n              )}\n              {cellInfo}\n            </div>\n          );\n        }\n        return <div style={colStyle}>{cellInfo}</div>;\n      };\n      cols[treeNodeColumnIndex] = treeNodeCol;\n      return cols;\n    },\n  },\n  watch: {\n    data: {\n      immediate: true,\n      handler(val) {\n        this.dataSource = cloneDeep(val);\n        this.store.initialTreeStore(this.dataSource, this.columns, this.rowDataKeys);\n      },\n    },\n  },\n  unmounted() {\n    this.store.treeDataMap?.clear();\n    this.store = null;\n  },\n  methods: {\n    getTreeNodeStyle(level: number) {\n      if (!level) return;\n      const indent = (this.tree as TableTreeConfig)?.indent || 24;\n      return { paddingLeft: `${level * indent}px` };\n    },\n\n    toggleExpandData(p: PrimaryTableCellParams<TableRowData>) {\n      this.store.toggleExpandData(p, this.dataSource, this.rowDataKeys);\n    },\n\n    /**\n     * 组件实例方法，设置行数据，自动刷新界面\n     * @param key 当前行唯一标识值\n     * @param newRowData 新行数据\n     */\n    setData<T>(key: TableRowValue, newRowData: T) {\n      const rowIndex = this.store.updateData(key, newRowData, this.dataSource, this.rowDataKeys);\n      this.dataSource[rowIndex] = newRowData;\n    },\n\n    /**\n     * 组件实例方法，获取当前行全部数据\n     * @param key 行唯一标识\n     * @returns {TableRowState} 当前行数据\n     */\n    getData(key: TableRowValue): TableRowState {\n      return this.store.getData(key);\n    },\n\n    /**\n     * 组件实例方法，移除指定节点\n     * @param key 行唯一标识\n     */\n    remove(key: TableRowValue) {\n      // 引用传值，可自动更新 this.dataSource\n      this.store.remove(key, this.dataSource, this.rowDataKeys);\n    },\n\n    /**\n     * 为当前节点添加子节点，默认添加到最后一个节点\n     * @param key 当前节点唯一标识\n     * @param newData 待添加的新节点\n     */\n    appendTo<T>(key: TableRowValue, newData: T) {\n      // 引用传值，可自动更新 this.dataSource\n      this.store.appendTo(key, newData, this.dataSource, this.rowDataKeys);\n    },\n  },\n});\n"],"names":["defineComponent","props","rowKey","baseTableProps","data","columns","primaryTableProps","tree","enhancedTableProps","store","TableTreeStore","dataSource","computed","rowDataKeys","childrenKey","columnsSource","treeNodeColumnIndex","type","cols","treeNodeCol","cell","h","p","cellInfo","getCell","col","currentState","treeDataMap","get","row","colStyle","getTreeNodeStyle","level","childrenNodes","Array","IconNode","expanded","MinusRectangleIcon","AddRectangleIcon","length","marginRight","toggleExpandData","watch","immediate","handler","val","cloneDeep","initialTreeStore","unmounted","clear","methods","indent","paddingLeft","setData","key","newRowData","rowIndex","updateData","getData","remove","appendTo","newData"],"mappings":"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"}