{"version":3,"file":"submenu.js","sources":["../../src/menu/submenu.tsx"],"sourcesContent":["import { defineComponent, computed, inject, ref, provide, onMounted, getCurrentInstance, watch } from 'vue';\nimport { prefix } from '../config';\nimport props from './submenu-props';\nimport { renderContent, renderTNodeJSX } from '../utils/render-tnode';\nimport { TdMenuInterface, TdSubMenuInterface, TdMenuItem } from './const';\nimport FakeArrow from '../common-components/fake-arrow';\nimport Ripple from '../utils/ripple';\nimport { ClassName } from '../common';\n\nexport default defineComponent({\n  name: 'TSubmenu',\n  directives: {\n    ripple: Ripple,\n  },\n  props,\n  setup(props, ctx) {\n    const menu = inject<TdMenuInterface>('TdMenu');\n    const { theme, activeValues, expandValues, mode, isHead, open } = menu;\n    const submenu = inject<TdSubMenuInterface>('TdSubmenu', null);\n\n    const menuItems = ref([]); // 因composition-api的缺陷，不用reactive， 详见：https://github.com/vuejs/composition-api/issues/637\n    const isActive = computed(() => activeValues.value.indexOf(props.value) > -1);\n    const popupVisible = ref(false);\n    const rippleColor = computed(() => (theme.value === 'light' ? '#E7E7E7' : '#383838'));\n    const isOpen = computed(() => {\n      if (mode.value === 'popup') {\n        return popupVisible.value;\n      }\n      return expandValues ? expandValues.value.includes(props.value) : false;\n    });\n    const isNested = ref(false); // 是否嵌套\n    const classes = computed(() => [\n      `${prefix}-submenu`,\n      {\n        [`${prefix}-is-disabled`]: props.disabled,\n        [`${prefix}-is-opened`]: isOpen.value,\n      },\n    ]);\n    const popupClass = computed(() => [\n      `${prefix}-menu__popup`,\n      {\n        [`${prefix}-is-opened`]: popupVisible.value,\n        [`${prefix}-is-vertical`]: !isHead,\n      },\n    ]);\n    const submenuClass = computed(() => [\n      `${prefix}-menu__item`,\n      {\n        [`${prefix}-is-disabled`]: props.disabled,\n        [`${prefix}-is-opened`]: isOpen.value,\n        [`${prefix}-is-active`]: isActive.value,\n      },\n    ]);\n    const subClass = computed(() => [\n      `${prefix}-menu__sub`,\n      {\n        [`${prefix}-is-opened`]: isOpen.value,\n      },\n    ]);\n    const arrowClass: ClassName = computed(() => [\n      {\n        [`${prefix}-fake-arrow--active`]: isOpen.value,\n      },\n    ]);\n\n    // methods\n    const handleMouseEnter = () => {\n      if (props.disabled) return;\n      if (!popupVisible.value) {\n        open(props.value);\n      }\n      popupVisible.value = true;\n    };\n    const handleMouseLeave = () => {\n      popupVisible.value = false;\n    };\n\n    const handleSubmenuItemClick = () => {\n      if (props.disabled) return;\n      open(props.value);\n    };\n\n    watch(popupVisible, (visible) => {\n      menu.open(props.value, visible ? 'add' : 'remove');\n    });\n\n    // provide\n    provide<TdSubMenuInterface>('TdSubmenu', {\n      value: props.value,\n      addMenuItem: (item: TdMenuItem) => {\n        menuItems.value.push(item);\n        if (submenu) {\n          submenu.addMenuItem(item);\n        }\n      },\n    });\n\n    onMounted(() => {\n      menu?.vMenu?.add({ value: props.value, parent: submenu?.value, vnode: ctx.slots.default });\n      const instance = getCurrentInstance();\n\n      isNested.value = /submenu/i.test(instance.parent?.type.name);\n\n      // adjust popup height\n      const { refs } = instance;\n      if (refs) {\n        const rect = (refs.popupInner as HTMLElement)?.getBoundingClientRect();\n        const $popup = refs.popup;\n\n        ($popup as HTMLElement)?.style?.setProperty('--popup-max-height', `${rect?.height}px`);\n        ($popup as HTMLElement)?.style?.setProperty('--popup-width', `${rect?.width}px`);\n      }\n    });\n\n    return {\n      menuItems,\n      mode,\n      isHead,\n      isNested,\n      classes,\n      subClass,\n      arrowClass,\n      popupClass,\n      submenuClass,\n      rippleColor,\n      handleMouseEnter,\n      handleMouseLeave,\n      handleSubmenuItemClick,\n    };\n  },\n  methods: {\n    renderHeadSubmenu() {\n      const normalSubmenu = [\n        <div v-ripple={this.rippleColor} class={this.submenuClass} onClick={this.handleSubmenuItemClick}>\n          {renderTNodeJSX(this, 'title')}\n        </div>,\n        <ul style=\"opacity: 0; width: 0; height: 0; overflow: hidden\">{renderContent(this, 'default', 'content')}</ul>,\n      ];\n\n      const popupSubmenu = [\n        <div class={this.submenuClass}>\n          {renderTNodeJSX(this, 'title')}\n          <FakeArrow\n            overlayClassName={this.arrowClass}\n            overlayStyle={{ transform: `rotate(${this.isNested ? -90 : 0}deg)` }}\n          />\n        </div>,\n        <div ref=\"popup\" class={this.popupClass}>\n          <ul ref=\"popupInner\" class={`${prefix}-menu__popup-wrapper`}>\n            {renderContent(this, 'default', 'content')}\n          </ul>\n        </div>,\n      ];\n      return this.mode === 'normal' ? normalSubmenu : popupSubmenu;\n    },\n    renderSubmenu() {\n      const hasContent = this.$slots.content || this.$slots.default;\n      const icon = renderTNodeJSX(this, 'icon');\n      const child = renderContent(this, 'default', 'content');\n      let { parent } = getCurrentInstance();\n      let paddingLeft = 44;\n\n      while (parent && parent.type.name !== 'TMenu') {\n        if (parent.type.name === 'TSubmenu') {\n          paddingLeft += 16;\n        }\n        parent = parent.parent;\n      }\n\n      const needRotate = this.mode === 'popup' && this.isNested;\n\n      const normalSubmenu = [\n        <div v-ripple={this.rippleColor} class={this.submenuClass} onClick={this.handleSubmenuItemClick}>\n          {icon}\n          <span class={[`${prefix}-menu__content`]}>{renderTNodeJSX(this, 'title')}</span>\n          {hasContent && (\n            <FakeArrow\n              overlayClassName={this.arrowClass}\n              overlayStyle={{ transform: `rotate(${needRotate ? -90 : 0}deg)` }}\n            />\n          )}\n        </div>,\n        <ul class={this.subClass} style={{ '--padding-left': `${paddingLeft}px` }}>\n          {child}\n        </ul>,\n      ];\n\n      const popupSubmenu = [\n        <div class={this.submenuClass}>\n          {icon}\n          <span class={[`${prefix}-menu__content`]}>{renderTNodeJSX(this, 'title')}</span>\n          <FakeArrow\n            overlayClassName={this.arrowClass}\n            overlayStyle={{ transform: `rotate(${needRotate ? -90 : 0}deg)` }}\n          />\n        </div>,\n        <div ref=\"popup\" class={this.popupClass}>\n          <ul ref=\"popupInner\" class={`${prefix}-menu__popup-wrapper`}>\n            {child}\n          </ul>\n        </div>,\n      ];\n\n      return this.mode === 'normal' ? normalSubmenu : popupSubmenu;\n    },\n  },\n  render() {\n    let child = null;\n    let events = {};\n\n    if (this.mode === 'popup') {\n      events = {\n        onmouseenter: this.handleMouseEnter,\n        onmouseleave: this.handleMouseLeave,\n      };\n    }\n    if (Object.keys(this.$slots).length > 0) {\n      child = this.isHead ? this.renderHeadSubmenu() : this.renderSubmenu();\n    }\n    return (\n      <li class={this.classes} {...events}>\n        {child}\n      </li>\n    );\n  },\n});\n"],"names":["defineComponent","name","directives","ripple","Ripple","props","setup","props2","ctx","menu","inject","theme","activeValues","expandValues","mode","isHead","open","submenu","menuItems","ref","isActive","computed","value","indexOf","popupVisible","rippleColor","isOpen","includes","isNested","classes","prefix","disabled","popupClass","submenuClass","subClass","arrowClass","handleMouseEnter","handleMouseLeave","handleSubmenuItemClick","watch","visible","provide","addMenuItem","item","push","onMounted","vMenu","add","parent","vnode","slots","instance","getCurrentInstance","test","type","refs","rect","popupInner","getBoundingClientRect","$popup","popup","style","setProperty","height","width","methods","renderHeadSubmenu","normalSubmenu","renderTNodeJSX","renderContent","popupSubmenu","transform","renderSubmenu","hasContent","$slots","content","icon","child","paddingLeft","needRotate","render","events","onmouseenter","onmouseleave","Object","keys","length"],"mappings":"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"}