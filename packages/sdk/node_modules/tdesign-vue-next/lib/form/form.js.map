{"version":3,"file":"form.js","sources":["../../src/form/form.tsx"],"sourcesContent":["import { defineComponent, VNode, ComponentPublicInstance } from 'vue';\nimport isEmpty from 'lodash/isEmpty';\nimport { prefix } from '../config';\nimport { FormValidateResult, TdFormProps, FormValidateParams } from './type';\nimport props from './props';\nimport { FORM_ITEM_CLASS_PREFIX, CLASS_NAMES } from './const';\nimport FormItem from './form-item';\nimport { FormResetEvent, FormSubmitEvent, ClassName } from '../common';\nimport { emitEvent } from '../utils/event';\n\nexport type FormItemInstance = InstanceType<typeof FormItem>;\n\ntype Result = FormValidateResult<TdFormProps['data']>;\n\nconst name = `${prefix}-form`;\n\nexport default defineComponent({\n  name: 'TForm',\n\n  provide(): { form: ComponentPublicInstance } {\n    return {\n      form: this,\n    };\n  },\n\n  props: { ...props },\n\n  emits: ['validate', 'submit', 'reset', 'form-item-destroyed'],\n\n  data() {\n    return {\n      children: [] as Array<FormItemInstance>,\n    };\n  },\n\n  computed: {\n    formClass(): ClassName {\n      return [\n        CLASS_NAMES.form,\n        {\n          [`${name}-inline`]: this.layout === 'inline',\n        },\n      ];\n    },\n  },\n\n  methods: {\n    getFirstError(r: Result) {\n      if (r === true) return;\n      const [firstKey] = Object.keys(r);\n      if (this.scrollToFirstError) {\n        this.scrollTo(`.${FORM_ITEM_CLASS_PREFIX + firstKey}`);\n      }\n      return r[firstKey][0].message;\n    },\n    // 校验不通过时，滚动到第一个错误表单\n    scrollTo(selector: string) {\n      const dom = this.$el.querySelector(selector);\n      // eslint-disable-next-line no-undef\n      const behavior = this.scrollToFirstError as ScrollBehavior;\n      dom && dom.scrollIntoView({ behavior });\n    },\n    isFunction(val: unknown) {\n      return typeof val === 'function';\n    },\n    needValidate(name: string, fields: string[]) {\n      if (!fields || !Array.isArray(fields)) return true;\n      return fields.indexOf(name) !== -1;\n    },\n    // 对外方法，该方法会触发表单组件错误信息显示\n    async validate(param?: FormValidateParams): Promise<Result> {\n      const { fields, trigger = 'all' } = param || {};\n      const list = this.children\n        .filter((child) => this.isFunction(child.validate) && this.needValidate(child.name, fields))\n        .map((child) => child.validate(trigger));\n      const arr = await Promise.all(list);\n      const r = arr.reduce((r, err) => Object.assign(r || {}, err));\n      Object.keys(r).forEach((key) => {\n        if (r[key] === true) {\n          delete r[key];\n        }\n      });\n      const result = isEmpty(r) ? true : r;\n      emitEvent(this, 'validate', {\n        validateResult: result,\n        firstError: this.getFirstError(result),\n      });\n      return result;\n    },\n    submitHandler(e?: FormSubmitEvent) {\n      if (this.preventSubmitDefault) {\n        e && e.preventDefault();\n        e && e.stopPropagation();\n      }\n      this.validate().then((r) => {\n        emitEvent(this, 'submit', {\n          validateResult: r,\n          firstError: this.getFirstError(r),\n          e,\n        });\n      });\n    },\n    resetHandler(e?: FormResetEvent) {\n      if (this.preventSubmitDefault) {\n        e && e.preventDefault();\n        e && e.stopPropagation();\n      }\n      this.children.filter((child: any) => this.isFunction(child.resetField)).map((child: any) => child.resetField());\n      emitEvent(this, 'reset', { e });\n    },\n    clearValidate(fields?: Array<string>) {\n      this.children.forEach((child) => {\n        if (this.isFunction(child.resetHandler) && this.needValidate(child.name, fields)) {\n          child.resetHandler();\n        }\n      });\n    },\n    // If there is no reset button in form, this function can be used\n    reset() {\n      this.resetHandler();\n    },\n    // If there is no submit button in form, this function can be used\n    submit() {\n      this.submitHandler();\n    },\n  },\n\n  render(): VNode {\n    return (\n      <form\n        ref=\"form\"\n        class={this.formClass}\n        onSubmit={(e) => this.submitHandler(e as MouseEvent)}\n        onReset={(e) => this.resetHandler(e as MouseEvent)}\n        {...this.$attrs}\n      >\n        {this.$slots.default ? this.$slots.default() : []}\n      </form>\n    );\n  },\n});\n"],"names":["name","prefix","defineComponent","provide","form","props","emits","data","children","computed","formClass","CLASS_NAMES","layout","methods","getFirstError","r","Object","keys","firstKey","scrollToFirstError","scrollTo","FORM_ITEM_CLASS_PREFIX","message","selector","dom","$el","querySelector","behavior","scrollIntoView","isFunction","val","needValidate","name2","fields","Array","isArray","indexOf","validate","param","trigger","list","filter","child","map","Promise","all","arr","reduce","r2","err","assign","forEach","key","result","isEmpty","emitEvent","validateResult","firstError","submitHandler","e","preventSubmitDefault","preventDefault","stopPropagation","then","resetHandler","resetField","clearValidate","reset","submit","render","$attrs","$slots"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAMA,IAAMA,IAAI,aAAMC,aAAN,UAAV;AACA,YAAeC,mBAAe,CAAC;AAC7BF,EAAAA,IAAI,EAAE,OADuB;AAE7BG,EAAAA,OAF6B,qBAEnB;AACR,WAAO;AACLC,MAAAA,IAAI,EAAE;AADD,KAAP;AAGD,GAN4B;AAO7BC,EAAAA,KAAK,oBAAOA,qBAAP,CAPwB;AAQ7BC,EAAAA,KAAK,EAAE,CAAC,UAAD,EAAa,QAAb,EAAuB,OAAvB,EAAgC,qBAAhC,CARsB;AAS7BC,EAAAA,IAT6B,kBAStB;AACL,WAAO;AACLC,MAAAA,QAAQ,EAAE;AADL,KAAP;AAGD,GAb4B;AAc7BC,EAAAA,QAAQ,EAAE;AACRC,IAAAA,SADQ,uBACI;AACV,aAAO,CACLC,sBAAW,CAACP,IADP,oDAGCJ,IAHD,cAGiB,KAAKY,MAAL,KAAgB,QAHjC,EAAP;AAMD;AARO,GAdmB;AAwB7BC,EAAAA,OAAO,EAAE;AACPC,IAAAA,aADO,yBACOC,CADP,EACU;AACf,UAAIA,CAAC,KAAK,IAAV,EACE;;AACF,yBAAmBC,MAAM,CAACC,IAAP,CAAYF,CAAZ,CAAnB;AAAA;AAAA,UAAOG,QAAP;;AACA,UAAI,KAAKC,kBAAT,EAA6B;AAC3B,aAAKC,QAAL,YAAkBC,iCAAsB,GAAGH,QAA3C;AACD;;AACD,aAAOH,CAAC,CAACG,QAAD,CAAD,CAAY,CAAZ,EAAeI,OAAtB;AACD,KATM;AAUPF,IAAAA,QAVO,oBAUEG,QAVF,EAUY;AACjB,UAAMC,GAAG,GAAG,KAAKC,GAAL,CAASC,aAAT,CAAuBH,QAAvB,CAAZ;AACA,UAAMI,QAAQ,GAAG,KAAKR,kBAAtB;AACAK,MAAAA,GAAG,IAAIA,GAAG,CAACI,cAAJ,CAAmB;AAAED,QAAAA,QAAQ,EAARA;AAAF,OAAnB,CAAP;AACD,KAdM;AAePE,IAAAA,UAfO,sBAeIC,GAfJ,EAeS;AACd,aAAO,OAAOA,GAAP,KAAe,UAAtB;AACD,KAjBM;AAkBPC,IAAAA,YAlBO,wBAkBMC,KAlBN,EAkBaC,MAlBb,EAkBqB;AAC1B,UAAI,CAACA,MAAD,IAAW,CAACC,KAAK,CAACC,OAAN,CAAcF,MAAd,CAAhB,EACE,OAAO,IAAP;AACF,aAAOA,MAAM,CAACG,OAAP,CAAeJ,KAAf,MAA0B,CAAC,CAAlC;AACD,KAtBM;AAuBDK,IAAAA,QAvBC,oBAuBQC,KAvBR,EAuBe;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,wBACgBA,KAAK,IAAI,EADzB,EACZL,MADY,SACZA,MADY,wBACJM,OADI,EACJA,OADI,8BACM,KADN;AAEdC,gBAAAA,IAFc,GAEP,KAAI,CAAChC,QAAL,CAAciC,MAAd,CAAqB,UAACC,KAAD;AAAA,yBAAW,KAAI,CAACb,UAAL,CAAgBa,KAAK,CAACL,QAAtB,KAAmC,KAAI,CAACN,YAAL,CAAkBW,KAAK,CAAC1C,IAAxB,EAA8BiC,MAA9B,CAA9C;AAAA,iBAArB,EAA0GU,GAA1G,CAA8G,UAACD,KAAD;AAAA,yBAAWA,KAAK,CAACL,QAAN,CAAeE,OAAf,CAAX;AAAA,iBAA9G,CAFO;AAAA;AAAA,uBAGFK,OAAO,CAACC,GAAR,CAAYL,IAAZ,CAHE;;AAAA;AAGdM,gBAAAA,GAHc;AAId/B,gBAAAA,CAJc,GAIV+B,GAAG,CAACC,MAAJ,CAAW,UAACC,EAAD,EAAKC,GAAL;AAAA,yBAAajC,MAAM,CAACkC,MAAP,CAAcF,EAAE,IAAI,EAApB,EAAwBC,GAAxB,CAAb;AAAA,iBAAX,CAJU;AAKpBjC,gBAAAA,MAAM,CAACC,IAAP,CAAYF,CAAZ,EAAeoC,OAAf,CAAuB,UAACC,GAAD,EAAS;AAC9B,sBAAIrC,CAAC,CAACqC,GAAD,CAAD,KAAW,IAAf,EAAqB;AACnB,2BAAOrC,CAAC,CAACqC,GAAD,CAAR;AACD;AACF,iBAJD;AAKMC,gBAAAA,MAVc,GAULC,2BAAO,CAACvC,CAAD,CAAP,GAAa,IAAb,GAAoBA,CAVf;AAWpBwC,gBAAAA,qBAAS,CAAC,KAAD,EAAO,UAAP,EAAmB;AAC1BC,kBAAAA,cAAc,EAAEH,MADU;AAE1BI,kBAAAA,UAAU,EAAE,KAAI,CAAC3C,aAAL,CAAmBuC,MAAnB;AAFc,iBAAnB,CAAT;AAXoB,iDAebA,MAfa;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAgBrB,KAvCM;AAwCPK,IAAAA,aAxCO,yBAwCOC,CAxCP,EAwCU;AAAA;;AACf,UAAI,KAAKC,oBAAT,EAA+B;AAC7BD,QAAAA,CAAC,IAAIA,CAAC,CAACE,cAAF,EAAL;AACAF,QAAAA,CAAC,IAAIA,CAAC,CAACG,eAAF,EAAL;AACD;;AACD,WAAKzB,QAAL,GAAgB0B,IAAhB,CAAqB,UAAChD,CAAD,EAAO;AAC1BwC,QAAAA,qBAAS,CAAC,MAAD,EAAO,QAAP,EAAiB;AACxBC,UAAAA,cAAc,EAAEzC,CADQ;AAExB0C,UAAAA,UAAU,EAAE,MAAI,CAAC3C,aAAL,CAAmBC,CAAnB,CAFY;AAGxB4C,UAAAA,CAAC,EAADA;AAHwB,SAAjB,CAAT;AAKD,OAND;AAOD,KApDM;AAqDPK,IAAAA,YArDO,wBAqDML,CArDN,EAqDS;AAAA;;AACd,UAAI,KAAKC,oBAAT,EAA+B;AAC7BD,QAAAA,CAAC,IAAIA,CAAC,CAACE,cAAF,EAAL;AACAF,QAAAA,CAAC,IAAIA,CAAC,CAACG,eAAF,EAAL;AACD;;AACD,WAAKtD,QAAL,CAAciC,MAAd,CAAqB,UAACC,KAAD;AAAA,eAAW,MAAI,CAACb,UAAL,CAAgBa,KAAK,CAACuB,UAAtB,CAAX;AAAA,OAArB,EAAmEtB,GAAnE,CAAuE,UAACD,KAAD;AAAA,eAAWA,KAAK,CAACuB,UAAN,EAAX;AAAA,OAAvE;AACAV,MAAAA,qBAAS,CAAC,IAAD,EAAO,OAAP,EAAgB;AAAEI,QAAAA,CAAC,EAADA;AAAF,OAAhB,CAAT;AACD,KA5DM;AA6DPO,IAAAA,aA7DO,yBA6DOjC,MA7DP,EA6De;AAAA;;AACpB,WAAKzB,QAAL,CAAc2C,OAAd,CAAsB,UAACT,KAAD,EAAW;AAC/B,YAAI,MAAI,CAACb,UAAL,CAAgBa,KAAK,CAACsB,YAAtB,KAAuC,MAAI,CAACjC,YAAL,CAAkBW,KAAK,CAAC1C,IAAxB,EAA8BiC,MAA9B,CAA3C,EAAkF;AAChFS,UAAAA,KAAK,CAACsB,YAAN;AACD;AACF,OAJD;AAKD,KAnEM;AAoEPG,IAAAA,KApEO,mBAoEC;AACN,WAAKH,YAAL;AACD,KAtEM;AAuEPI,IAAAA,MAvEO,oBAuEE;AACP,WAAKV,aAAL;AACD;AAzEM,GAxBoB;AAmG7BW,EAAAA,MAnG6B,oBAmGpB;AAAA;;AACP;AAAA,aAAiB,MAAjB;AAAA,eAA+B,KAAK3D,SAApC;AAAA,kBAAyD,kBAACiD,CAAD;AAAA,eAAO,MAAI,CAACD,aAAL,CAAmBC,CAAnB,CAAP;AAAA,OAAzD;AAAA,iBAAgG,iBAACA,CAAD;AAAA,eAAO,MAAI,CAACK,YAAL,CAAkBL,CAAlB,CAAP;AAAA;AAAhG,OAAiI,KAAKW,MAAtI,IAA+I,KAAKC,MAAL,cAAsB,KAAKA,MAAL,aAAtB,GAA8C,EAA7L;AACD;AArG4B,CAAD,CAA9B;;;;"}