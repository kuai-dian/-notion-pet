/**
 * tdesign v0.8.0
 * (c) 2022 tdesign
 * @license MIT
 */

'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var _asyncToGenerator = require('@babel/runtime/helpers/asyncToGenerator');
var vue = require('vue');
var _regeneratorRuntime = require('@babel/runtime/regenerator');
var isFunction = require('lodash/isFunction');
var config = require('../config.js');
var utils_dom = require('../utils/dom.js');
var affix_props = require('./props.js');
var utils_renderTnode = require('../utils/render-tnode.js');
require('../_chunks/dep-eb6b0f94.js');
require('lodash/isString');
require('../utils/easing.js');
require('lodash/isEmpty');
require('lodash/isObject');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var _asyncToGenerator__default = /*#__PURE__*/_interopDefaultLegacy(_asyncToGenerator);
var _regeneratorRuntime__default = /*#__PURE__*/_interopDefaultLegacy(_regeneratorRuntime);
var isFunction__default = /*#__PURE__*/_interopDefaultLegacy(isFunction);

var name = "".concat(config.prefix, "-affix");
var _Affix = vue.defineComponent({
  name: "TAffix",
  props: affix_props["default"],
  emits: ["fixedChange"],
  setup: function setup(props2, _ref) {
    var emit = _ref.emit;
    var instance = vue.getCurrentInstance();
    var fixedTop = vue.ref(false);
    var oldWidthHeight = vue.ref({
      width: "0px",
      height: "0px"
    });
    var scrollContainer = vue.ref();
    var containerHeight = vue.ref(0);
    var ticking = vue.ref(false);

    var calcInitValue = function calcInitValue() {
      var _containerHeight = 0;

      if (scrollContainer.value instanceof Window) {
        _containerHeight = scrollContainer.value.innerHeight;
      } else {
        _containerHeight = scrollContainer.value.clientHeight;
      }

      containerHeight.value = _containerHeight - instance.ctx.$el.clientHeight;

      var _ref2 = instance.ctx.$el.querySelector(".".concat(name)) || instance.ctx.$el,
          clientWidth = _ref2.clientWidth,
          clientHeight = _ref2.clientHeight;

      oldWidthHeight.value = {
        width: "".concat(clientWidth, "px"),
        height: "".concat(clientHeight, "px")
      };
      handleScroll();
    };

    var handleScroll = function handleScroll() {
      if (!ticking.value) {
        window.requestAnimationFrame(function () {
          var _instance$ctx$$el$get = instance.ctx.$el.getBoundingClientRect(),
              top = _instance$ctx$$el$get.top;

          var containerTop = 0;

          if (scrollContainer.value instanceof HTMLElement) {
            containerTop = scrollContainer.value.getBoundingClientRect().top;
          }

          var calcTop = top - containerTop;
          var calcBottom = containerTop + containerHeight.value - props2.offsetBottom;

          if (props2.offsetTop !== void 0 && calcTop <= props2.offsetTop) {
            fixedTop.value = containerTop + props2.offsetTop;
          } else if (props2.offsetBottom !== void 0 && top >= calcBottom) {
            fixedTop.value = calcBottom;
          } else {
            fixedTop.value = false;
          }

          ticking.value = false;
          emit("fixedChange", fixedTop.value !== false, {
            top: fixedTop.value
          });
          if (isFunction__default["default"](props2.onFixedChange)) props2.onFixedChange(fixedTop.value !== false, {
            top: fixedTop.value
          });
        });
        ticking.value = true;
      }
    };

    vue.watch(function () {
      return props2.offsetTop;
    }, function () {
      calcInitValue();
    });
    vue.watch(function () {
      return props2.offsetBottom;
    }, function () {
      calcInitValue();
    });
    vue.onMounted( /*#__PURE__*/_asyncToGenerator__default["default"]( /*#__PURE__*/_regeneratorRuntime__default["default"].mark(function _callee() {
      return _regeneratorRuntime__default["default"].wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              _context.next = 2;
              return vue.nextTick();

            case 2:
              scrollContainer.value = utils_dom.getScrollContainer(props2.container);
              calcInitValue();
              utils_dom.on(scrollContainer.value, "scroll", handleScroll);
              utils_dom.on(window, "resize", calcInitValue);
              if (!(scrollContainer.value instanceof Window)) utils_dom.on(window, "scroll", handleScroll);

            case 7:
            case "end":
              return _context.stop();
          }
        }
      }, _callee);
    })));
    vue.onBeforeUnmount(function () {
      if (!scrollContainer.value) return;
      utils_dom.off(scrollContainer.value, "scroll", handleScroll);
      utils_dom.off(window, "resize", calcInitValue);
      if (!(scrollContainer.value instanceof Window)) utils_dom.off(window, "scroll", handleScroll);
    });
    return {
      fixedTop: fixedTop,
      oldWidthHeight: oldWidthHeight,
      scrollContainer: scrollContainer
    };
  },
  render: function render() {
    var oldWidthHeight = this.oldWidthHeight,
        fixedTop = this.fixedTop,
        zIndex = this.zIndex;

    if (fixedTop !== false) {
      return vue.createVNode("div", this.$attrs, [vue.createVNode("div", {
        "style": oldWidthHeight
      }, null), vue.createVNode("div", {
        "class": name,
        "style": {
          zIndex: zIndex,
          top: "".concat(fixedTop, "px"),
          width: oldWidthHeight.width
        }
      }, [utils_renderTnode.renderTNodeJSX(this, "default")])]);
    }

    return vue.createVNode("div", null, [utils_renderTnode.renderTNodeJSX(this, "default")]);
  }
});

exports["default"] = _Affix;
//# sourceMappingURL=affix.js.map
