{"version":3,"file":"affix.js","sources":["../../src/affix/affix.tsx"],"sourcesContent":["import { ref, watch, nextTick, getCurrentInstance, onMounted, onBeforeUnmount, defineComponent } from 'vue';\nimport isFunction from 'lodash/isFunction';\nimport { prefix } from '../config';\nimport { on, off, getScrollContainer } from '../utils/dom';\nimport props from './props';\nimport { ScrollContainerElement } from '../common';\nimport { renderTNodeJSX } from '../utils/render-tnode';\n\nconst name = `${prefix}-affix`;\n\nexport default defineComponent({\n  name: 'TAffix',\n  props,\n  emits: ['fixedChange'],\n  setup(props, { emit }) {\n    const instance = getCurrentInstance() as any;\n    const fixedTop = ref<false | number>(false);\n    const oldWidthHeight = ref({\n      width: '0px',\n      height: '0px',\n    });\n    const scrollContainer = ref<ScrollContainerElement>();\n    const containerHeight = ref(0);\n    const ticking = ref(false);\n\n    const calcInitValue = () => {\n      let _containerHeight = 0; // 获取当前可视的高度\n      if (scrollContainer.value instanceof Window) {\n        _containerHeight = scrollContainer.value.innerHeight;\n      } else {\n        _containerHeight = scrollContainer.value.clientHeight;\n      }\n      // 需要减掉当前节点的高度，对比的高度应该从 border-top 比对开始\n      containerHeight.value = _containerHeight - instance.ctx.$el.clientHeight;\n      // 被包裹的子节点宽高\n      const { clientWidth, clientHeight } = instance.ctx.$el.querySelector(`.${name}`) || instance.ctx.$el;\n      oldWidthHeight.value = { width: `${clientWidth}px`, height: `${clientHeight}px` };\n      handleScroll();\n    };\n\n    const handleScroll = () => {\n      if (!ticking.value) {\n        window.requestAnimationFrame(() => {\n          const { top } = instance.ctx.$el.getBoundingClientRect(); // top = 节点到页面顶部的距离，包含 scroll 中的高度\n          let containerTop = 0; // containerTop = 容器到页面顶部的距离\n          if (scrollContainer.value instanceof HTMLElement) {\n            containerTop = scrollContainer.value.getBoundingClientRect().top;\n          }\n          const calcTop = top - containerTop; // 节点顶部到 container 顶部的距离\n          const calcBottom = containerTop + containerHeight.value - props.offsetBottom; // 计算 bottom 相对应的 top 值\n          if (props.offsetTop !== undefined && calcTop <= props.offsetTop) {\n            // top 的触发\n            fixedTop.value = containerTop + props.offsetTop;\n          } else if (props.offsetBottom !== undefined && top >= calcBottom) {\n            // bottom 的触发\n            fixedTop.value = calcBottom;\n          } else {\n            fixedTop.value = false;\n          }\n          ticking.value = false;\n          emit('fixedChange', fixedTop.value !== false, { top: fixedTop.value });\n          if (isFunction(props.onFixedChange)) props.onFixedChange(fixedTop.value !== false, { top: fixedTop.value });\n        });\n        ticking.value = true;\n      }\n    };\n\n    watch(\n      () => props.offsetTop,\n      () => {\n        calcInitValue();\n      },\n    );\n\n    watch(\n      () => props.offsetBottom,\n      () => {\n        calcInitValue();\n      },\n    );\n\n    onMounted(async () => {\n      await nextTick();\n      scrollContainer.value = getScrollContainer(props.container);\n      calcInitValue();\n      on(scrollContainer.value, 'scroll', handleScroll);\n      on(window, 'resize', calcInitValue);\n      if (!(scrollContainer.value instanceof Window)) on(window, 'scroll', handleScroll);\n    });\n\n    onBeforeUnmount(() => {\n      if (!scrollContainer.value) return;\n      off(scrollContainer.value, 'scroll', handleScroll);\n      off(window, 'resize', calcInitValue);\n      if (!(scrollContainer.value instanceof Window)) off(window, 'scroll', handleScroll);\n    });\n\n    return {\n      fixedTop,\n      oldWidthHeight,\n      scrollContainer,\n    };\n  },\n  render() {\n    const { oldWidthHeight, fixedTop, zIndex } = this;\n\n    if (fixedTop !== false) {\n      return (\n        <div {...this.$attrs}>\n          <div style={oldWidthHeight}></div>\n          <div class={name} style={{ zIndex, top: `${fixedTop}px`, width: oldWidthHeight.width }}>\n            {renderTNodeJSX(this, 'default')}\n          </div>\n        </div>\n      );\n    }\n\n    return <div>{renderTNodeJSX(this, 'default')}</div>;\n  },\n});\n"],"names":["name","prefix","defineComponent","props","emits","setup","props2","emit","instance","getCurrentInstance","fixedTop","ref","oldWidthHeight","width","height","scrollContainer","containerHeight","ticking","calcInitValue","_containerHeight","value","Window","innerHeight","clientHeight","ctx","$el","querySelector","clientWidth","handleScroll","window","requestAnimationFrame","getBoundingClientRect","top","containerTop","HTMLElement","calcTop","calcBottom","offsetBottom","offsetTop","isFunction","onFixedChange","watch","onMounted","nextTick","getScrollContainer","container","on","onBeforeUnmount","off","render","zIndex","$attrs","renderTNodeJSX"],"mappings":"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"}