{"version":3,"file":"anchor.js","sources":["../../src/anchor/anchor.tsx"],"sourcesContent":["import { defineComponent, nextTick, ComponentPublicInstance } from 'vue';\nimport CLASSNAMES from '../utils/classnames';\nimport { ANCHOR_SHARP_REGEXP, ANCHOR_CONTAINER, getOffsetTop } from './utils';\nimport { on, off, getScroll, scrollTo, getScrollContainer } from '../utils/dom';\nimport props from './props';\nimport { renderTNodeJSX } from '../utils/render-tnode';\nimport { SlotReturnValue } from '../common';\nimport Affix from '../affix';\nimport { COMPONENT_NAME } from './constant';\nimport { emitEvent } from '../utils/event';\n\nconst ANCHOR_LINE_CLASSNAME = `${COMPONENT_NAME}__line`;\nconst ANCHOR_LINE_CURSOR_CLASSNAME = `${COMPONENT_NAME}__line-cursor`;\n\nexport interface Anchor extends ComponentPublicInstance {\n  scrollContainer: ANCHOR_CONTAINER;\n  // 执行scrollTo设置的flag, 用来禁止执行handleScroll\n  handleScrollLock: boolean;\n}\n\nexport default defineComponent({\n  name: 'TAnchor',\n\n  provide(): any {\n    return {\n      tAnchor: this,\n    };\n  },\n\n  props: { ...props },\n\n  emits: ['change', 'click'],\n\n  data() {\n    return {\n      links: [] as string[],\n      active: '',\n      scrollContainer: null as ANCHOR_CONTAINER,\n      activeLineStyle: {} as { top: string; height: string; opacity: number },\n    };\n  },\n\n  watch: {\n    attach() {\n      // 清空上一个container的事件监听\n      if (this.scrollContainer) {\n        off(this.scrollContainer, 'scroll', this.handleScroll);\n      }\n      this.getScrollContainer();\n    },\n  },\n\n  async mounted() {\n    const { active } = this;\n    this.getScrollContainer();\n    if (active) {\n      await nextTick();\n      this.handleScrollTo(active);\n    }\n  },\n\n  unmounted() {\n    if (!this.scrollContainer) return;\n    off(this.scrollContainer, 'scroll', this.handleScroll);\n  },\n\n  methods: {\n    /**\n     * 获取滚动容器\n     * 1. 如果是string则通过id获取\n     * 2. 如果是method则获取方法返回值\n     */\n    getScrollContainer(): void {\n      const { container } = this;\n      this.scrollContainer = getScrollContainer(container) as HTMLElement;\n      on(this.scrollContainer, 'scroll', this.handleScroll);\n      this.handleScroll();\n    },\n    /**\n     * 获取锚点对应的target元素\n     *\n     * @param {string} link\n     */\n    getAnchorTarget(link: string): HTMLElement {\n      const matcher = link.match(ANCHOR_SHARP_REGEXP);\n      if (!matcher) {\n        return;\n      }\n      const anchor = document.getElementById(matcher[1]);\n      if (!anchor) {\n        return;\n      }\n      return anchor;\n    },\n    /**\n     * 注册锚点\n     *\n     * @param {string} link\n     */\n    registerLink(link: string): void {\n      const { links } = this;\n      if (!ANCHOR_SHARP_REGEXP.test(link) || links.indexOf(link) !== -1) {\n        return;\n      }\n      links.push(link);\n    },\n    /**\n     * 注销锚点\n     *\n     * @param {string} link\n     */\n    unregisterLink(link: string): void {\n      this.links = this.links.filter((each) => each !== link);\n    },\n    /**\n     * 设置当前激活状态锚点\n     *\n     * @param {string} link\n     */\n    async setCurrentActiveLink(link: string): Promise<void> {\n      const { active } = this;\n      if (active === link) {\n        return;\n      }\n      this.active = link;\n      this.emitChange(link, active);\n      await nextTick();\n      this.updateActiveLine();\n    },\n    /**\n     * 计算active-line所在的位置\n     * 当前active-item的top + height, 以及ANCHOR_ITEM_PADDING修正\n     */\n    updateActiveLine(): void {\n      const ele = this.$el.querySelector(`.${CLASSNAMES.STATUS.active}>a`) as HTMLAnchorElement;\n      if (!ele) {\n        this.activeLineStyle = null;\n        return;\n      }\n      const { offsetTop: top, offsetHeight: height } = ele;\n      this.activeLineStyle = {\n        top: `${top}px`,\n        height: `${height}px`,\n        opacity: 1,\n      };\n    },\n    /**\n     * 触发onchange事件或者props\n     *\n     * @param {string} currentLink\n     * @param {string} prevLink\n     */\n    emitChange(currentLink: string, prevLink: string) {\n      emitEvent(this, 'change', currentLink, prevLink);\n    },\n    /**\n     * 监听AnchorLink点击事件\n     * @param {{ href: string; title: string }} link\n     */\n    handleLinkClick(link: { href: string; title: string }): void {\n      emitEvent(this, 'click', link);\n    },\n    /**\n     * 滚动到指定锚点\n     *\n     * @param {string} link\n     */\n    async handleScrollTo(link: string): Promise<void> {\n      const anchor = this.getAnchorTarget(link);\n      this.setCurrentActiveLink(link);\n      if (!anchor) return;\n      this.handleScrollLock = true;\n      const { scrollContainer, targetOffset } = this;\n      const scrollTop = getScroll(scrollContainer);\n      const offsetTop = getOffsetTop(anchor, scrollContainer);\n      const top = scrollTop + offsetTop - targetOffset;\n      await scrollTo(top, {\n        container: scrollContainer,\n      });\n      this.handleScrollLock = false;\n    },\n    /**\n     * 监听滚动事件\n     */\n    handleScroll(): void {\n      if (this.handleScrollLock) return;\n      const { links, bounds, targetOffset } = this;\n      const filters: { top: number; link: string }[] = [];\n      let active = '';\n      // 找出所有当前top小于预设值\n      links.forEach((link) => {\n        const anchor = this.getAnchorTarget(link);\n        if (!anchor) {\n          return;\n        }\n        const top = getOffsetTop(anchor, this.scrollContainer);\n        if (top < bounds + targetOffset) {\n          filters.push({\n            link,\n            top,\n          });\n        }\n      });\n      // 找出小于预设值集合中top最大的\n      if (filters.length) {\n        const latest = filters.reduce((prev, cur) => (prev.top > cur.top ? prev : cur));\n        active = latest.link;\n      }\n      this.setCurrentActiveLink(active);\n    },\n    renderCursor() {\n      const titleContent: SlotReturnValue = renderTNodeJSX(this, 'cursor');\n      return titleContent || <div class={ANCHOR_LINE_CURSOR_CLASSNAME}></div>;\n    },\n  },\n\n  render() {\n    const {\n      $slots: { default: children },\n      size,\n      affixProps,\n      activeLineStyle,\n      $attrs,\n    } = this;\n    const className = [COMPONENT_NAME, CLASSNAMES.SIZE[size]];\n\n    const content = (\n      <div class={className} {...$attrs}>\n        <div class={ANCHOR_LINE_CLASSNAME}>\n          <div class={`${ANCHOR_LINE_CURSOR_CLASSNAME}-wrapper`} style={activeLineStyle}>\n            {this.renderCursor()}\n          </div>\n        </div>\n        {children && children(null)}\n      </div>\n    );\n\n    if (affixProps) {\n      return <Affix {...affixProps}>{content}</Affix>;\n    }\n\n    return content;\n  },\n});\n"],"names":["ANCHOR_LINE_CLASSNAME","COMPONENT_NAME","ANCHOR_LINE_CURSOR_CLASSNAME","defineComponent","name","provide","tAnchor","props","emits","data","links","active","scrollContainer","activeLineStyle","watch","attach","off","handleScroll","getScrollContainer","mounted","nextTick","handleScrollTo","unmounted","methods","container","on","getAnchorTarget","link","matcher","match","ANCHOR_SHARP_REGEXP","anchor","document","getElementById","registerLink","test","indexOf","push","unregisterLink","filter","each","setCurrentActiveLink","emitChange","updateActiveLine","ele","$el","querySelector","CLASSNAMES","STATUS","top","offsetTop","height","offsetHeight","opacity","currentLink","prevLink","emitEvent","handleLinkClick","handleScrollLock","targetOffset","scrollTop","getScroll","getOffsetTop","scrollTo","bounds","filters","forEach","length","latest","reduce","prev","cur","renderCursor","titleContent","renderTNodeJSX","render","children","$slots","size","affixProps","$attrs","className","SIZE","content"],"mappings":"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"}