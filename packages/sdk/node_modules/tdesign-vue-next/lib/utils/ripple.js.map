{"version":3,"file":"ripple.js","sources":["../../src/utils/ripple.ts"],"sourcesContent":["/* eslint-disable no-undef */\n\n/**\n * 用法\n * v-ripple\n * 固定色值 v-ripple=\"动画条的背景色\" eg: v-ripple=\"#808080\"\n * 动态色值(推荐) v-ripple=\"true\" data.ripple=\"rippleColor\"\n */\n\nimport { DirectiveBinding } from 'vue';\nimport setStyle from './set-style';\nimport { prefix } from '../config';\n\nlet startTimeId = null as NodeJS.Timeout;\n\nconst Ripple = {\n  mounted(el: HTMLElement, binding: DirectiveBinding) {\n    const period = 200;\n    const defaultBg = 'rgba(0, 0, 0, 0.35)';\n    let bg = typeof binding.value === 'boolean' ? defaultBg : binding.value;\n    const rippleContainer = document.createElement('div');\n    let hasCreateContainer = false;\n    let count = 0;\n\n    el.addEventListener('pointerdown', (e: PointerEvent) => {\n      if (\n        el.classList.contains(`${prefix}-is-active`) ||\n        el.classList.contains(`${prefix}-is-disabled`) ||\n        el.classList.contains(`${prefix}-is-checked`)\n      )\n        return;\n\n      if (e.button !== 0) return; // 非鼠标左键点击；避免出现动画之后不消失的bug\n\n      // 支持通过dataset传递背景色\n      if (bg === defaultBg && el.dataset.ripple) {\n        bg = el.dataset.ripple;\n      }\n\n      // 支持通过css variable传递背景色\n      const cssVariable = getComputedStyle(el).getPropertyValue('--ripple-color');\n      if (cssVariable) {\n        bg = cssVariable;\n      }\n\n      const elBorder = parseInt(getComputedStyle(el).borderWidth.replace('px', ''), 10);\n      const border = elBorder > 0 ? elBorder : 0;\n      const width = el.offsetWidth;\n      const height = el.offsetHeight;\n      const style = getComputedStyle(el);\n\n      if (!hasCreateContainer) {\n        hasCreateContainer = true;\n        setStyle(rippleContainer, {\n          position: 'absolute',\n          left: `${0 - border}px`,\n          top: `${0 - border}px`,\n          width: `${width}px`,\n          height: `${height}px`,\n          borderRadius: style.borderRadius,\n          pointerEvents: 'none',\n          overflow: 'hidden',\n        });\n        el.appendChild(rippleContainer);\n      }\n\n      const ripple = document.createElement('div');\n\n      setStyle(ripple, {\n        marginTop: '0',\n        marginLeft: '0',\n        right: `${width}px`,\n        width: `${width + 20}px`,\n        height: '100%',\n        transition: `transform ${period}ms cubic-bezier(.38, 0, .24, 1), background ${period * 2}ms linear`,\n        transform: 'skewX(-8deg)',\n        pointerEvents: 'none',\n        position: 'absolute',\n        zIndex: '0',\n        backgroundColor: bg,\n        opacity: '0.9',\n      });\n\n      // fix zIndex：避免遮盖内部元素\n      const elMap = new WeakMap();\n      for (let n = el.children.length, i = 0; i < n; ++i) {\n        const child = el.children[i];\n        if ((child as HTMLElement).style.zIndex === '' && child !== rippleContainer) {\n          (child as HTMLElement).style.zIndex = '1';\n          elMap.set(child, true);\n        }\n      }\n\n      // fix position\n      const initPosition = el.style.position ? el.style.position : getComputedStyle(el).position;\n      if (initPosition === '' || initPosition === 'static') {\n        // eslint-disable-next-line no-param-reassign\n        el.style.position = 'relative';\n      }\n\n      rippleContainer.insertBefore(ripple, rippleContainer.firstChild);\n      count += 1;\n\n      clearTimeout(startTimeId);\n      startTimeId = setTimeout(() => {\n        ripple.style.transform = `translateX(${width}px)`;\n      }, 0);\n\n      const handleClearRipple = () => {\n        ripple.style.backgroundColor = 'rgba(0, 0, 0, 0)';\n\n        el.removeEventListener('pointerup', handleClearRipple, false);\n        el.removeEventListener('pointerleave', handleClearRipple, false);\n\n        setTimeout(() => {\n          rippleContainer.removeChild(ripple);\n          count -= 1;\n          if (count > 0) return; // 避免因为移除了relative的定位，从而导致动画漂移\n          // eslint-disable-next-line no-param-reassign\n          el.style.position = initPosition !== 'static' ? initPosition : '';\n\n          // reset zIndex\n          for (let n = el.children.length, i = 0; i < n; ++i) {\n            const child: Element = el.children[i];\n            if (elMap.has(child)) {\n              (child as HTMLElement).style.zIndex = '';\n              elMap.delete(child);\n            }\n          }\n          // 由于容器的尺寸可能会发生变更，因此在动画结束之后，手动移除\n          el.removeChild(rippleContainer);\n          hasCreateContainer = false;\n        }, period * 2 + 100);\n      };\n      el.addEventListener('pointerup', handleClearRipple, false);\n      el.addEventListener('pointerleave', handleClearRipple, false); // 处理鼠标按下不松手直接离开点击block的情况..\n    });\n  },\n};\n\nexport default Ripple;\n"],"names":["startTimeId","Ripple","mounted","el","binding","period","defaultBg","bg","value","rippleContainer","document","createElement","hasCreateContainer","count","addEventListener","e","classList","contains","prefix","button","dataset","ripple","cssVariable","getComputedStyle","getPropertyValue","elBorder","parseInt","borderWidth","replace","border","width","offsetWidth","height","offsetHeight","style","setStyle","position","left","top","borderRadius","pointerEvents","overflow","appendChild","marginTop","marginLeft","right","transition","transform","zIndex","backgroundColor","opacity","elMap","WeakMap","n","children","length","i","child","set","initPosition","insertBefore","firstChild","clearTimeout","setTimeout","handleClearRipple","removeEventListener","removeChild","has"],"mappings":"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"}